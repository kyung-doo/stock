<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ìƒìŠ¹ë¥  ìƒìœ„ ì¢…ëª© ì¶”ì²œê¸°</title>
    <style>
      body {
        font-family: sans-serif;
      }
      #loading {
        display: none;
        font-weight: bold;
        color: blue;
      }
      table {
        border-collapse: collapse;
        margin-top: 10px;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 4px 8px;
        text-align: center;
      }
      input,
      textarea,
      select {
        margin: 4px;
      }
      #chartModal {
        display: none;
        position: fixed;
        top: 10%;
        left: 10%;
        width: 80%;
        height: 80%;
        background: #fff;
        border: 1px solid #ccc;
        padding: 10px;
        z-index: 1000;
        overflow: auto;
      }
      #kospi {
        font-size: 20px;
        color: #333;
      }
    </style>
  </head>
  <body>
    <h2>ğŸ“ˆ ìƒìŠ¹ë¥  ìƒìœ„ ì¢…ëª© ì¶”ì²œê¸° <span id="kospi">ì˜ˆì¸¡ ì½”ìŠ¤í”¼ì§€ìˆ˜ ë¶ˆëŸ¬ì˜¤ëŠ”ì¤‘...</span></h2>
    <button id="showKospiChart">ğŸ“Š ìµœê·¼ 3ê°œì›” KOSPI ì‹¤ì œ vs ì˜ˆì¸¡ ë³´ê¸°</button>
    <fieldset style="margin-top: 20px;">
      <legend>ë°ì´í„° ë° í•„í„°</legend>
      ìƒìœ„ ì¶”ì²œ Nê°œ: <input id="topN" type="number" value="20" /><br />
      ìµœì†Œ ë™ë°˜í•˜ë½ ë¹„ìœ¨:
      <input id="minCoDown" type="number" step="0.01" value="0.5" /><br />
      ìµœëŒ€ ATR%: <input id="maxATR" type="number" step="0.1" value="10" /><br />
      ì§€ìˆ˜ ë¯¼ê°ë„ ìµœê·¼ ì¼ìˆ˜:
      <input id="recentDays" type="number" value="10" /><br />

      <!-- âœ… ê°œì›” ìˆ˜ ì„ íƒ -->
      ê¸°ê°„(ê°œì›”):
      <select id="months">
        <option value="1">1ê°œì›”</option>
        <option value="2">2ê°œì›”</option>
        <option value="3" selected>3ê°œì›”</option>
        <option value="4">4ê°œì›”</option>
        <option value="5">5ê°œì›”</option>
        <option value="6">6ê°œì›”</option>
        <option value="7">7ê°œì›”</option>
        <option value="8">8ê°œì›”</option>
        <option value="9">9ê°œì›”</option>
        <option value="10">10ê°œì›”</option>
        <option value="11">11ê°œì›”</option>
        <option value="12">12ê°œì›”</option></select
      ><br />

      <button id="run">ì¶”ì²œ ì‹¤í–‰</button>
      <button id="reset">ì´ˆê¸°í™”</button>
      <div id="loading">â³ ì¶”ì²œ ê³„ì‚° ì¤‘...</div>
    </fieldset>

    <fieldset>
      <legend>ì¶”ì²œ ê²°ê³¼</legend>
      <table id="result">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Name</th>
            <th>Return</th>
            <th>Co-Down Rate</th>
            <th>ATR%</th>
            <th>Score</th>
            <th>Buy Price</th>
            <th>Sell Price</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </fieldset>

    <fieldset>
      <legend>ë¦¬ìŠ¤í¬ ê´€ë¦¬ (í¬ì§€ì…˜ ì‚¬ì´ì§•)</legend>
      ì¶”ì²œ ì¢…ëª© ì„ íƒ:
      <select id="selectedSymbol">
        <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option></select
      ><br />
      ì´ íˆ¬ììê¸ˆ(ì›):
      <input id="capital" type="text" value="1,000,000" /><br />
      íŠ¸ë ˆì´ë“œë‹¹ ë¦¬ìŠ¤í¬(%):
      <input id="riskPct" type="number" step="0.1" value="1" /><br />
      ì§„ì…ê°€(ì›): <input id="entryPrice" type="text" /><br />
      ì†ì ˆê°€(ì›): <input id="stopPrice" type="text" /><br />
      ì°°ì‚°/í˜¸ê°€ ë³´ì •(fx):
      <input id="adjustFx" type="number" step="0.1" value="1" /><br />
      <button id="calcRisk">ë¦¬ìŠ¤í¬ ê³„ì‚°</button>
      <div id="riskResult"></div>
    </fieldset>

    <!-- ëª¨ë‹¬ íŒì—… -->
    <div id="chartModal">
      <button
        onclick="document.getElementById('chartModal').style.display='none'"
      >
        ë‹«ê¸°
      </button>
      <div id="chartContainer" style="width: 100%; height: 90%"></div>
    </div>

    <!-- ëª¨ë‹¬ íŒì—… -->
    <div id="chartModal">
      <button onclick="document.getElementById('chartModal').style.display='none'">
        ë‹«ê¸°
      </button>
      <div id="chartContainer" style="width: 100%; height: 90%"></div>
    </div>

    <!-- âœ… ìƒˆë¡œìš´ ëª¨ë‹¬: 3ê°œì›” ì‹¤ì œ vs ì˜ˆì¸¡ -->
    <div id="kospiModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; border:1px solid #ccc; padding:10px; z-index:1000; overflow:auto;">
      <button onclick="document.getElementById('kospiModal').style.display='none'">ë‹«ê¸°</button>
      <div id="kospiChartContainer" style="width:100%; height:90%"></div>
    </div>



    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      const qs = (id) => document.getElementById(id);

      async function init() {
        try{
          const res = await fetch(`/kospi-predict`);
          const json = await res.json();
          qs('kospi').innerHTML = `rmse: ${json.rmse}, ì˜¤ëŠ˜ ì˜ˆì¸¡ ì½”ìŠ¤í”¼: ${json.todayClose}, ë‹¤ìŒ 6ì¼ ì˜ˆì¸¡ ì½”ìŠ¤í”¼: ${json.weekClose.join(', ')}`;
          // âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê³  ì°¨íŠ¸ í‘œì‹œ
          qs("showKospiChart").addEventListener("click", () => {
            document.getElementById("kospiModal").style.display = "block";
            Plotly.newPlot("kospiChartContainer", json.chart.data, json.chart.layout);
          });

        } catch(e) {
          console.error(e);
        }
      }
      init();

      // ì¶”ì²œ ì‹¤í–‰
      qs("run").addEventListener("click", async () => {
        qs("loading").style.display = "block";
        const topN = parseInt(qs("topN").value, 10);
        const minCoDown = parseFloat(qs("minCoDown").value);
        const maxATR = parseFloat(qs("maxATR").value);
        const months = parseInt(qs("months").value, 10); // âœ… ì„ íƒí•œ ê°œì›” ìˆ˜ ë°˜ì˜

        const res = await fetch(`/top-risers?topN=${topN}&months=${months}`);
        const json = await res.json();
        qs("loading").style.display = "none";

        const tbody = document.querySelector("#result tbody");
        tbody.innerHTML = "";
        const select = qs("selectedSymbol");
        select.innerHTML = '<option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>';

        json.symbols.forEach((s) => {
          if (s.coDownRate < minCoDown || s.atrPct > maxATR) return;
          const score = s.rMonths * 100 - s.atrPct * 0.5 + s.coDownRate * 100;

          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${s.symbol}</td>
        <td class="stockName" style="cursor:pointer; color:blue;">${s.name}</td>
        <td>${(s.rMonths * 100).toFixed(2)}%</td>
        <td>${(s.coDownRate * 100).toFixed(2)}%</td>
        <td>${s.atrPct.toFixed(2)}%</td>
        <td>${score.toFixed(2)}</td>
        <td>${Math.round(s.buyPrice).toLocaleString()}</td>
        <td>${Math.round(s.sellPrice).toLocaleString()}</td>
      `;
          tbody.appendChild(tr);

          // ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€
          const opt = document.createElement("option");
          opt.value = JSON.stringify(s);
          opt.text = `${s.symbol} (${s.name})`;
          select.appendChild(opt);

          // ì¢…ëª©ëª… í´ë¦­ ì‹œ ì°¨íŠ¸ ëª¨ë‹¬ ì—´ê¸°
          tr.querySelector(".stockName").addEventListener("click", async () => {
            const kospiRes = await fetch(
              `/daily?symbol=^KS11&months=${months}`
            );
            const kospiData = await kospiRes.json();
            const stockRes = await fetch(
              `/daily?symbol=${s.symbol}&months=${months}`
            );
            const stockData = await stockRes.json();

            document.getElementById("chartModal").style.display = "block";

            const kospiTrace = {
              x: kospiData.map((d) => d.date),
              y: kospiData.map((d) => d.close),
              type: "scatter",
              mode: "lines",
              name: "ì½”ìŠ¤í”¼ ì§€ìˆ˜",
              line: { color: "green" },
              yaxis: "y2",
            };

            const stockTrace = {
              x: stockData.map((d) => d.date),
              open: stockData.map((d) => d.open),
              high: stockData.map((d) => d.high),
              low: stockData.map((d) => d.low),
              close: stockData.map((d) => d.close),
              type: "candlestick",
              name: `${s.name} ìº”ë“¤`,
              yaxis: "y",
              increasing: { line: { color: "red" } },
              decreasing: { line: { color: "blue" } },
            };

            const layout = {
              title: `${s.name} (${s.symbol}) + ì½”ìŠ¤í”¼ ì§€ìˆ˜`,
              height: 600,
              xaxis: {
                title: "ë‚ ì§œ",
                rangeslider: { visible: false },
                tickformat: "%Y-%m-%d",
              },
              yaxis: { title: `${s.name} ì£¼ê°€` },
              yaxis2: {
                title: "ì½”ìŠ¤í”¼ ì§€ìˆ˜",
                overlaying: "y",
                side: "right",
                showgrid: false,
              },
              legend: { title: { text: "ë²”ë¡€" }, orientation: "h" },
            };

            Plotly.newPlot("chartContainer", [stockTrace, kospiTrace], layout);
          });
        });
      });

      // ì´ˆê¸°í™”
      qs("reset").addEventListener("click", () => {
        document.querySelector("#result tbody").innerHTML = "";
        qs("selectedSymbol").innerHTML =
          '<option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>';
      });

      // ì¢…ëª© ì„ íƒ ì‹œ ì§„ì…ê°€/ì†ì ˆê°€ ìë™ ì±„ìš°ê¸°
      qs("selectedSymbol").addEventListener("change", () => {
        if (!qs("selectedSymbol").value) return;
        const s = JSON.parse(qs("selectedSymbol").value);
        qs("entryPrice").value = Math.round(s.buyPrice).toLocaleString();
        qs("stopPrice").value = Math.round(s.buyPrice * 0.95).toLocaleString();
      });

      // ë¦¬ìŠ¤í¬ ê³„ì‚°
      qs("calcRisk").addEventListener("click", () => {
        const capital = parseFloat(qs("capital").value.replace(/,/g, ""));
        const riskPct = parseFloat(qs("riskPct").value);
        const entry = parseFloat(qs("entryPrice").value.replace(/,/g, ""));
        const stop = parseFloat(qs("stopPrice").value.replace(/,/g, ""));
        const fx = parseFloat(qs("adjustFx").value);

        if (!entry || !stop) {
          qs("riskResult").innerText = "âš ï¸ ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”.";
          return;
        }

        const riskPerTrade = capital * (riskPct / 100);
        const lossPerShare = entry - stop;
        const qty = Math.floor(riskPerTrade / lossPerShare / fx);
        const total = qty * entry;

        qs(
          "riskResult"
        ).innerText = `ì¶”ì²œ ìˆ˜ëŸ‰: ${qty.toLocaleString()}ì£¼, ì´ íˆ¬ìê¸ˆ: ${total.toLocaleString()}ì›`;

        qs("capital").value = Math.round(capital).toLocaleString();
        qs("entryPrice").value = Math.round(entry).toLocaleString();
        qs("stopPrice").value = Math.round(stop).toLocaleString();
      });
    </script>
  </body>
</html>
